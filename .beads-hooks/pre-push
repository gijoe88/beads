#!/usr/bin/env sh
# bd-hooks-version: 0.24.3
#
# bd (beads) pre-push hook
#
# This hook prevents pushing stale JSONL by:
# 1. Flushing any pending in-memory changes to JSONL (if bd available)
# 2. Checking for uncommitted changes (staged, unstaged, untracked, deleted)
# 3. Auto-committing staged-only changes, or failing with instructions if unstaged
#
# The pre-commit hook already exports changes, but this catches:
# - Changes made between commit and push
# - Pending debounced flushes (5s daemon delay)
#
# Installation:
#   cp examples/git-hooks/pre-push .git/hooks/pre-push
#   chmod +x .git/hooks/pre-push
#
# Or use the install script:
#   examples/git-hooks/install.sh

# Check if we're in a bd workspace
if [ ! -d .beads ]; then
    # Not a bd workspace, nothing to do
    exit 0
fi

# Skip if bd sync is already in progress (GH#532: prevents circular error)
# bd sync sets this env var when pushing from worktree
if [ -n "$BD_SYNC_IN_PROGRESS" ]; then
    exit 0
fi

# Optionally flush pending bd changes so they surface in JSONL
# This prevents the race where a debounced flush lands after the check
if command -v bd >/dev/null 2>&1; then
    bd sync --flush-only >/dev/null 2>&1 || true
fi

# Collect all tracked or existing JSONL files (beads.jsonl, issues.jsonl for backward compat, deletions.jsonl for deletion propagation)
FILES=""
for f in .beads/beads.jsonl .beads/issues.jsonl .beads/deletions.jsonl; do
    # Include file if it exists in working tree OR is tracked by git (even if deleted)
    if git ls-files --error-unmatch "$f" >/dev/null 2>&1 || [ -f "$f" ]; then
        FILES="$FILES $f"
    fi
done

# Check for any uncommitted changes using porcelain status
# This catches: staged, unstaged, untracked, deleted, renamed, and conflicts
if [ -n "$FILES" ]; then
    # shellcheck disable=SC2086
    if [ -n "$(git status --porcelain -- $FILES 2>/dev/null)" ]; then
        # Check if changes are only staged (ready to commit) vs unstaged
        # shellcheck disable=SC2086
        STAGED=$(git diff --cached --name-only -- $FILES 2>/dev/null)
        # shellcheck disable=SC2086
        UNSTAGED=$(git diff --name-only -- $FILES 2>/dev/null)
        # shellcheck disable=SC2086
        UNTRACKED=$(git ls-files --others --exclude-standard -- $FILES 2>/dev/null)

        # If only staged changes exist (no unstaged/untracked), auto-commit them
        if [ -n "$STAGED" ] && [ -z "$UNSTAGED" ] && [ -z "$UNTRACKED" ]; then
            echo "ðŸ“ Auto-committing staged JSONL changes..." >&2
            # shellcheck disable=SC2086
            git commit -m "chore: sync beads JSONL [pre-push hook]" --no-verify -- $FILES
            if [ $? -eq 0 ]; then
                echo "âœ“ Committed. Continuing with push..." >&2
            else
                echo "âš ï¸ Commit failed, but proceeding with push anyway..." >&2
            fi
            # Continue to push - don't exit here, let the push proceed
        else
            # Has unstaged or untracked changes - fail and prompt user
            echo "âŒ Error: Beads JSONL has uncommitted changes" >&2
            echo "" >&2
            echo "You made changes to bd issues between your last commit and this push." >&2
            echo "" >&2

            # Check if bd is available and offer auto-sync
            if command -v bd >/dev/null 2>&1; then
                # Check if we're in an interactive terminal
                if [ -t 0 ]; then
                    echo "Would you like to run 'bd sync' now to commit and push these changes? [y/N]" >&2
                    read -r response
                    case "$response" in
                        [yY][eE][sS]|[yY])
                            echo "" >&2
                            echo "Running: bd sync" >&2
                            if bd sync; then
                                echo "" >&2
                                echo "âœ“ Sync complete. Continuing with push..." >&2
                                exit 0
                            else
                                echo "" >&2
                                echo "âŒ Sync failed. Push aborted." >&2
                                exit 1
                            fi
                            ;;
                        *)
                            echo "" >&2
                            echo "Push aborted. Run 'bd sync' manually when ready:" >&2
                            echo "" >&2
                            echo "  bd sync" >&2
                            echo "  git push" >&2
                            echo "" >&2
                            exit 1
                            ;;
                    esac
                else
                    # Non-interactive: just show the message
                    echo "Run 'bd sync' to commit these changes:" >&2
                    echo "" >&2
                    echo "  bd sync" >&2
                    echo "" >&2
                    exit 1
                fi
            else
                # bd not available, fall back to manual git commands
                echo "Please commit the updated JSONL before pushing:" >&2
                echo "" >&2
                # shellcheck disable=SC2086
                echo "  git add $FILES" >&2
                echo '  git commit -m "Update bd JSONL"' >&2
                echo "  git push" >&2
                echo "" >&2
                exit 1
            fi
        fi
    fi
fi

exit 0
